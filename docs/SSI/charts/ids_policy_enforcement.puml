@startuml


participant ConnectorA as "Connector A"

participant ConnectorB as "Connector B"
participant WalletB as "Wallet B"

actor OwnerB as "Owner B"


== Connector Setup ==

OwnerB -> ConnectorB ++ : Configure trusted membership issuer to\n <i>did:sov:indy:<authority-company/catena-x></i>
return

OwnerB -> ConnectorB ++ : Create Data Offer for <i>BPN00001111</i>\nand regions <i>Germany, Spain, Netherlands or Italy</i>

    note right
        see for example policy
        [[./../examples/credentials_policy.json]]
    end note

return


== Messaging ==

ConnectorA -> ConnectorB ++ : IDS Catalog Request Message with w3c:VerifiablePresentation

    ConnectorB -> ConnectorB ++ : **Validate Membership**
        ConnectorB -> WalletB ++: Structural Presentation Validation
        return ok
        ConnectorB -> ConnectorB ++ : Check Audience Credential subject is Connector B
        return ok
        ConnectorB -> ConnectorB ++ : Check Membership Credential Issuer is Catena-X Authority Wallet
        return ok
    return ok

    ... process IDS Message ...

    ConnectorB -> ConnectorB ++ : **Validate Policies**

        ConnectorB -> ConnectorB ++ : Search presentation cache for Membership Credential of Connector A
        return found

        ConnectorB -> ConnectorB ++ : Search presentation cache for Address Credential of Connector A
        return not found

        ConnectorB -> ConnectorA ++ : IDS Credential Request Message \nfor AddressCredential
        return VP with Address Credential & Audience Credential

    return ok

    ... process IDS Message ...

return IDS Response MEssage

@enduml